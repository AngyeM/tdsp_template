from sklearn.feature_extraction.text import TfidfVectorizer

medicamentos={"prednisolona": "a07ea01","imiquimod": "d06bb10","ciproterone": "g03ha01","ciproterone y estrogeno": "g03hb01","tirotropina": "h01ab01","octreotido": "h01cb02","lanreotido": "h01cb03","dexametasona": "h02ab02","metilprednisolona": "h02ab04","prednisolona": "h02ab06","prednisona": "h02ab07","ciclofosfamida": "l01aa01","clorambucil": "l01aa02","melfalan": "l01aa03","ifosfamida": "l01aa06","bendamustine": "l01aa09","busulfan": "l01ab01","tiotepa": "l01ac01","carmustina": "l01ad01","ranimustine": "l01ad07","temozolomida": "l01ax03","dacarbazina": "l01ax04","pemetrexed": "l01ba04","pralatrexato": "l01ba05","mercaptopurina": "l01bb02","tioguanine": "l01bb03","cladribina": "l01bb04","fludarabina": "l01bb05","clofarabina": "l01bb06","citarabina": "l01bc01","fluorouracilo": "l01bc02","gemcitabina": "l01bc05","capecitabina": "l01bc06","azacitidina": "l01bc07","decitabina": "l01bc08","trifluridine": "l01bc59","vinblastina": "l01ca01","vincristina": "l01ca02","vindesine": "l01ca03","vinorelbina": "l01ca04","etoposido": "l01cb01","paclitaxel": "l01cd01","paclitaxel": "l01cd01","docetaxel": "l01cd02","paclitaxel":"l01cd03","poliglumex": "l01cd03","cabazitaxel": "l01cd04","trabectedin": "l01cx01","dactinomicina": "l01da01","doxorubicina": "l01db01","doxorrubicina": "l01db01","daunorrubicina": "l01db02","epirrubicina": "l01db03","idarrubicina": "l01db06","mitoxantrona": "l01db07","bleomicina": "l01dc01","mitomicina": "l01dc03","ixabepilona": "l01dc04","cisplatino": "l01xa01","carboplatino": "l01xa02","oxaliplatino": "l01xa03","procarbazine": "l01xb01","edrecolomab": "l01xc01","rituximab": "l01xc02","trastuzumab": "l01xc03","gemtuzumab": "l01xc05","ozogamicin": "l01xc05","cetuximab": "l01xc06","bevacizumab": "l01xc07","panitumumab": "l01xc08","catumaxomab": "l01xc09","ofatumumab": "l01xc10","ipilimumab": "l01xc11","pertuzumab": "l01xc13","obinutuzumab": "l01xc15","nivolumab": "l01xc17","pembrolizumab": "l01xc18","blinatumomab": "l01xc19","ramucirumab": "l01xc21","necitumumab": "l01xc22","elotuzumab": "l01xc23","daratumumab": "l01xc24","mogamulizumab": "l01xc25","olaratumab": "l01xc27","durvalumab": "l01xc28","bermekimab": "l01xc29","avelumab": "l01xc31","atezolizumab": "l01xc32","cemiplimab": "l01xc33","nimotuzumab": "l01xc99","aminolevulinato": "l01xd03","imatinib": "l01xe01","gefitinib": "l01xe02","erlotinib": "l01xe03","sunitinib": "l01xe04","sorafenib": "l01xe05","dasatinib": "l01xe06","lapatinib": "l01xe07","nilotinib": "l01xe08","temsirolimus": "l01xe09","everolimus": "l01xe10","pazopanib": "l01xe11","vandetanib": "l01xe12","afatinib": "l01xe13","bosutinib": "l01xe14","vemurafenib": "l01xe15","crizotinib": "l01xe16","axitinib": "l01xe17","ruxolitinib": "l01xe18","ridaforolimus": "l01xe19","regorafenib": "l01xe21","masitinib": "l01xe22","dabrafenib": "l01xe23","ponatinib": "l01xe24","trametinib": "l01xe25","cabozantinib": "l01xe26","ibrutinib": "l01xe27","ceritinib": "l01xe28","lenvatinib": "l01xe29","nintedanib": "l01xe31","cediranib": "l01xe32","palbociclib": "l01xe33","tivozanib": "l01xe34","osimertinib": "l01xe35","alectinib": "l01xe36","rociletinib": "l01xe37","cobimetinib": "l01xe38","midostaurin": "l01xe39","olmutinib": "l01xe40","binimetinib": "l01xe41","ribociclib": "l01xe42","brigatinib": "l01xe43","lorlatinib": "l01xe44","neratinib": "l01xe45","encorafenib": "l01xe46","dacomitinib": "l01xe47","icotinib": "l01xe48","abemaciclib": "l01xe50","acalabrutinib": "l01xe51","quizartinib": "l01xe52","larotrectinib": "l01xe53","gilteritinib": "l01xe54","entrectinib": "l01xe56","fedratinib": "l01xe57","asparaginasa": "l01xx02","hidroxicarbamida": "l01xx05","tretinoin": "l01xx14","topotecan": "l01xx17","irinotecan": "l01xx19","mitotane": "l01xx23","pegaspargasa": "l01xx24","bortezomib": "l01xx32","erlotinib": "l01xx34","anagrelide": "l01xx35","vismodegib": "l01xx43","carfilzomib": "l01xx45","olaparib": "l01xx46","niraparib": "l01xx54","copanlisib": "l01xx61","dietilestilbestrol": "l02aa01","megestrol": "l02ab01","leuprorelina": "l02ae02","goserelin": "l02ae03","triptorelin": "l02ae04","tamoxifeno": "l02ba01","fulvestrant": "l02ba03","flutamida": "l02bb01","bicalutamida": "l02bb03","enzalutamida": "l02bb04","apalutamida": "l02bb05","anastrozol": "l02bg03","letrozol": "l02bg04","exemestano": "l02bg06","degarelix": "l02bx02","abiraterona": "l02bx03","pegfilgrastim": "l03aa13","mifamurtida": "l03ax15","antitimocito": "l04aa04","everolimus": "l04aa18","vedolizumab": "l04aa33","ciclosporina": "l04ad01","azatioprina": "l04ax01","talidomide": "l04ax02","metotrexate": "l04ax03","lenalidomida": "l04ax04","pomalidomida": "l04ax06","alendronico": "m05ba04","zoledronico": "m05ba08","denosumab": "m05bx04","cloruro de radio": "v10xx03","ixazomib": "l01xx50","venetoclax": "l01xx52","ibandronico": "m05ba06","belinostat": "l01xh04","lomustine": "l01ad02","tegafur": "l01bc03","vorinostat": "l01xh01","alemtuzumab": "l04aa34","interferon alfa 2a": "l03ab04","interferon alfa 2b": "l03ab05","estramustina": "l01xx11","pamidronato": "m05ba03","blinatumumab": "l01fx07","daralutamida": "l02bb06"}

def data_clustering(df):
     pre_text = df.contenido.apply(preprocess)
     df = df.assign(norm_text = pre_text)
     vect = TfidfVectorizer(sublinear_tf=True, min_df=20).fit(df.norm_text)
     features = vect.transform(df.norm_text).toarray()
     
     nombres_medicamentos=list(medicamentos.keys())
     feature_names = vect.get_feature_names_out()
     cups=[t for t in feature_names if re.match('^\d{6}$',t) is not None]
     cie10=[t for t in feature_names if re.match('^[a-z]{1}[0-9]{2}([0-9]|x{1})$',t) is not None]
     medicamentos=[t for t in feature_names if t in nombres_medicamentos]
     data={}
     data['cups']=cups
     data['cie10']=cie10
     data['medicamentos']=medicamentos

     columns_to_keep = data['cups']+data['cie10']+data['medicamentos']
     filtered_tfidf = tfidf_df[columns_to_keep]
     return filtered_tfidf